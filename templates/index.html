<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>Vitals Summary</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #7928CA;
      --primary-dark: #6A0DAD;
      --secondary: #FF0080;
      --text: #E0C3FC;
      --background: #0F1116;
      --card-bg: rgba(255, 255, 255, 0.05);
      --error: #FF4E4E;
      --success: #00CC88;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top right, #1a1a2e, var(--background));
      color: var(--text);
      padding: 30px;
      min-height: 100vh;
    }

    .container {
      max-width: 100%;
      margin: auto;
      margin-top: 50px;
      display: flex;
      gap: 20px;
    }

    .left-panel,
    .right-panel {
      width: 150px;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 12px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      font-size: 12px;
    }

    .main-content {
      flex: 1;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 25px;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
      min-width: 0;
      position: relative;
    }

    .patient-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      padding: 12px;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }

    .patient-details::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      z-index: 1;
    }

    .patient-details>div {
      background: rgba(255, 255, 255, 0.03);
      padding: 8px 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 12px;
    }

    .patient-details>div:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary);
    }

    .patient-details strong {
      color: var(--secondary);
      font-size: 11px;
      font-weight: 500;
      display: inline;
      margin-right: 4px;
      letter-spacing: 0.5px;
    }

    .patient-details span {
      font-size: 12px;
      color: white;
      font-weight: 400;
    }

    .tabs,
    .right-tabs {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .tabs div,
    .right-tabs div {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 8px;
      white-space: nowrap;
      text-align: center;
    }

    .tabs div.active,
    .right-tabs div.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: transparent;
      box-shadow: 0 10px 20px rgba(121, 40, 202, 0.3);
    }

    .tabs div:hover,
    .right-tabs div:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.1);
    }

    .table-container {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
    }

    th,
    td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    th {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    td {
      background: rgba(255, 255, 255, 0.03);
      transition: background 0.3s ease;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.05);
    }

    .documentation-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 15px;
      transition: transform 0.3s ease;
    }

    .documentation-card:hover {
      transform: translateY(-2px);
    }

    button,
    .back-btn,
    .download-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-family: 'Poppins', sans-serif;
      text-decoration: none;
      display: inline-block;
    }

    button:hover,
    .back-btn:hover,
    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(121, 40, 202, 0.3);
    }

    input[type="date"] {
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      color: white;
      font-family: 'Poppins', sans-serif;
      margin-right: 10px;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        padding: 8px;
        gap: 10px;
      }

      .left-panel,
      .right-panel {
        width: 100%;
      }

      .tabs,
      .right-tabs {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 5px;
      }

      .tabs div,
      .right-tabs div {
        padding: 8px 10px;
        font-size: 10px;
      }

      .patient-details {
        grid-template-columns: repeat(2, 1fr);
        padding: 10px;
        gap: 8px;
      }

      #documentation-container {
        flex-direction: column;
      }

      #documentation-list {
        width: 100% !important;
        max-height: 150px;
        border-right: none !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
    }

    .section-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .pmh-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pmh-item {
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text);
    }

    .pmh-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .medical-history-section {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .section-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      border-radius: 12px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      letter-spacing: 0.5px;
    }

    .header-icon {
      opacity: 0.9;
    }

    .pmh-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 5px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .pmh-item {
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 14px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .pmh-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .condition-marker {
      width: 8px;
      height: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      flex-shrink: 0;
    }

    .pmh-empty {
      padding: 20px;
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .pmh-empty svg {
      opacity: 0.5;
      width: 32px;
      height: 32px;
    }

    /* Custom scrollbar for pmh-list */
    .pmh-list::-webkit-scrollbar {
      width: 6px;
    }

    .pmh-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 3px;
    }

    .pmh-list::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .pmh-list::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    @media (max-width: 768px) {
      .pmh-list {
        max-height: none;
      }

      .pmh-item {
        padding: 10px 12px;
      }
    }

    .info-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
    }

    .info-content {
      color: var(--text);
      font-size: 14px;
      line-height: 1.8;
      white-space: pre-wrap;
      padding: 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
    }

    .info-empty svg {
      opacity: 0.5;
      width: 40px;
      height: 40px;
    }

    .table-container h3 {
      color: white;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-container h3::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      border-radius: 2px;
    }

    /* Tab content animations */
    .table-container {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Update the tabs styling */
    .tabs div {
      padding: 14px 20px;
      font-size: 11px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Custom styling for specific tabs */
    .info-section {
      display: grid;
      gap: 20px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-item strong {
      display: block;
      color: var(--secondary);
      margin-bottom: 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-item span {
      color: white;
      font-size: 14px;
      line-height: 1.6;
    }

    /* Documentation improvements */
    .documentation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .documentation-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .documentation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .documentation-card h4 {
      color: white;
      margin-bottom: 10px;
      font-size: 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }

    .documentation-card p {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.5;
    }

    .documentation-card strong {
      color: var(--primary);
      font-weight: 600;
    }

    .download-btn {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .download-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .date-info {
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      margin-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 8px;
    }

    /* Form improvements */
    #doc-form {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #doc-form label {
      color: var(--text);
      font-size: 14px;
    }

    /* Mobile responsiveness improvements */
    @media (max-width: 768px) {
      .info-card {
        padding: 15px;
      }

      .info-content {
        padding: 15px;
      }

      .documentation-card {
        padding: 20px;
      }

      #doc-form {
        flex-direction: column;
        align-items: stretch;
      }

      .table-container h3 {
        font-size: 18px;
      }
    }

    .info-section {
      display: grid;
      gap: 15px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .info-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .item-icon {
      font-size: 20px;
      opacity: 0.9;
    }

    .medication-details {
      flex: 1;
    }

    .medication-details span {
      display: block;
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
    }

    .table-container h3 {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-container h3 svg {
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .info-item {
        padding: 15px;
      }

      .item-icon {
        font-size: 18px;
      }

      .table-container h3 {
        font-size: 18px;
      }
    }

    .back-btn {
      margin-left: 30px;
      /* Align with the page padding */
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(121, 40, 202, 0.3);
    }

    @media (max-width: 768px) {
      .back-btn {
        margin-left: 15px;
        font-size: 13px;
        padding: 8px 16px;
      }
    }

    /* Modal and Form Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
      transform: scale(0.9) translateY(20px);
      transition: all 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-title {
      color: white;
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .form-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 12px 15px;
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(121, 40, 202, 0.2);
    }

    .form-input::placeholder {
      color: rgba(224, 195, 252, 0.6);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(121, 40, 202, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .error-message {
      color: var(--error);
      font-size: 12px;
      margin-top: 5px;
    }

    .success-message {
      color: var(--success);
      font-size: 12px;
      margin-top: 5px;
    }

    .dropdown-container {
      position: relative;
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .report-dropdown {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 12px 15px;
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .report-dropdown:focus {
      border-color: #FF0080;
      background: rgba(255, 255, 255, 0.15);
      outline: none;
    }

    .report-dropdown option {
      background: var(--background);
      color: white;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toolbar-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      margin-left: 8px;
      backdrop-filter: blur(10px);
      opacity: 1;
      pointer-events: auto;
    }
    
    #edit-report-btn {
      background: linear-gradient(135deg, #FF0080, #7928CA);
    }
    
    #add-report-btn {
      background: linear-gradient(135deg, #00CC88, #7928CA);
    }

    .toolbar-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    #edit-report-btn:hover {
      background: linear-gradient(135deg, #FF2A94, #8B3BD8);
    }
    
    #add-report-btn:hover {
      background: linear-gradient(135deg, #1AD99C, #8B3BD8);
    }

    .toolbar-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      pointer-events: none;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Patient Information Section -->
  <div
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
    <div style="display: flex; flex-direction: column; gap: 5px;">
      {% if is_admin_view %}
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
          <a href="{% url 'admin_dashboard' %}" style="color: #7928CA; text-decoration: none;">Admin Dashboard</a> 
          / <a href="{% url 'admin_patient_list' %}" style="color: #7928CA; text-decoration: none;">Patient Information</a> 
          / Patient Details
        </div>
      {% endif %}
      <div style="display: flex; align-items: center; gap: 15px;">
        <h2 style="color: white; font-size: 18px; margin: 0;">{{patient.user.first_name}} {{patient.user.last_name}}
          ({{patient.age}} yrs)</h2>
      </div>
    </div>
    <div style="display: flex; gap: 10px;">
      {% if is_admin_view %}
        <a href="{% url 'admin_patient_list' %}" class="back-btn" style="padding: 6px 12px; font-size: 12px;">‚Üê Back to Patient List</a>
      {% else %}
        <a href="/view-patient/" class="back-btn" style="padding: 6px 12px; font-size: 12px;">‚Üê Back</a>
      {% endif %}
      <a href="{% url 'edit_patient' patient.id %}" class="edit-btn">
        <button
          style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z" />
          </svg>
          Edit
        </button>
      </a>
    </div>
  </div>

  <div class="patient-details">
    <div>
      <strong>Name:</strong>
      <span>{{patient.user.first_name}} {{patient.user.last_name}}</span>
    </div>
    <div>
      <strong>DOB:</strong>
      <span>{{patient.date_of_birth}}</span>
    </div>
    <div>
      <strong>Age:</strong>
      <span>{{patient.age}} yrs</span>
    </div>
    <div>
      <strong>Sex:</strong>
      <span>{{patient.sex}}</span>
    </div>
    <div>
      <strong>Weight:</strong>
      <span>{{patient.weight}} pounds</span>
    </div>
    <div>
      <strong>Height:</strong>
      <span>{{patient.height}} inches</span>
    </div>
    <div>
      <strong>BMI:</strong>
      <span>{{patient.bmi}}</span>
    </div>
    <div>
      <strong>Insurance:</strong>
      <span>{{patient.insurance}}</span>
    </div>
    <div>
      <strong>Monitoring:</strong>
      <span>{{patient.monitoring_parameters}}</span>
    </div>
    <div>
      <strong>Device ID:</strong>
      <span>{{patient.device_serial_number}}</span>
    </div>
    <div>
      <strong>Drink:</strong>
      <span>{{patient.drink}}</span>
    </div>
    <div>
      <strong>Smoke:</strong>
      <span>{{patient.smoke}}</span>
    </div>
    <div>
      <strong>Allergies:</strong>
      <span>{{patient.allergies|default:"None"}}</span>
    </div>
    <div>
      <strong>Start:</strong>
      <span>{{patient.created_at|date:"m/d/Y"}}</span>
    </div>
    <div>
      <strong>Updated:</strong>
      <span>{{patient.updated_at|date:"m/d/Y"}}</span>
    </div>
    <div>
      <strong>Moderator:</strong>
      <span>{{patient.moderator_assigned.user.username}}</span>
    </div>
  </div>

  <div class="container">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="tabs">
        <div class="active" onclick="showTab('results')">Results</div>
        <div onclick="showTab('orders')">Orders</div>
        <div onclick="showTab('documentation')">Documentation</div>
        <div onclick="showTab('allergies')">Allergies</div>
        <div onclick="showTab('family_history')">Family History</div>
        <div onclick="showTab('medications')">Medications</div>
        <div onclick="showTab('pharmacy')">Pharmacy</div>
      </div>
    </div>

    <!-- Main Content Section -->
    <div class="main-content">
      <!-- Content Section for Tabs -->
      <div class="content">
        <!-- Results Tab -->
        <div id="results" class="table-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Vitals Summary</h3>
            <div class="report-toolbar" style="display: flex; gap: 8px;">
              <button id="edit-report-btn" class="toolbar-btn" title="Edit Report (Ctrl+E)">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
              </button>
              <button id="add-report-btn" class="toolbar-btn" title="Add New Report (Ctrl+N)">
                <i class="fas fa-plus"></i>
                <span>Add</span>
              </button>
            </div>
          </div>
          <div class="scrollable">
            <table>
              <thead>
                <tr>
                  <th class="fixed-left">Vital Signs</th>
                  <!-- Headers will be populated dynamically -->
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>

        <div id="report-details" class="table-container" style="display: none">
          <div id="report-content"></div>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="table-container" style="display: none">
          <h3>Orders</h3>
          <table>
            <thead>
              <tr>
                <th class="left-col fixed-left">Order</th>
                <th>9/27/2024</th>
                <th>9/27/2024</th>
                <th>9/27/2024</th>
                <th>9/27/2024</th>
                <th>Additional Info</th>
                <!-- New column -->
              </tr>
              <tr>
                <th class="left-col fixed-left"></th>
                <th>10:37 AM</th>
                <th>11:24 AM</th>
                <th>12:10 PM</th>
                <th>1:32 PM</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="left-col">O2</td>
                <td>Ordered</td>
                <td>Administered</td>
                <td>Discontinued</td>
                <td>---</td>
                <td>Details</td>
              </tr>
              <tr>
                <td class="left-col">Mobility</td>
                <td>Initiated</td>
                <td>On Hold</td>
                <td>---</td>
                <td>Restarted</td>
                <td>Comments</td>
              </tr>
              <tr>
                <td class="left-col">Allergy</td>
                <td>Penicillin</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>Confirmed</td>
                <td>Extra info</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Documentation Tab -->
        <div id="documentation" class="table-container" style="display: none">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Documentation</h3>

            <a href="{% url 'add_documentation' patient.id %}" class="add-button">
              <button class="add-button"
                style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; border: none; cursor: pointer; font-size: 12px; height: 30px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                </svg>
                Add
              </button>
            </a>
          </div>
          <div id="documentation-container"
            style="display: flex; height: 55vh; min-height: 300px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; overflow: hidden;">
            <!-- Left panel - Documentation list -->
            <div id="documentation-list"
              style="width: 25%; overflow-y: auto; border-right: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.1);">
              <!-- Documentation list will be loaded here -->
              <div style="padding: 10px; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 12px;">
                Loading documentation...
              </div>
            </div>

            <!-- Right panel - Documentation details -->
            <div id="documentation-details"
              style="flex: 1; padding: 15px; overflow-y: auto; background: rgba(0, 0, 0, 0.05);">
              <!-- Documentation details will be loaded here -->
              <div
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.5);">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" style="margin-bottom: 10px; opacity: 0.5;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p style="font-size: 12px;">Select a document to view details</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Allergies Tab -->
        <div id="allergies" class="table-container" style="display: none">
          <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm1-9h-2v6h2zm0-4h-2v2h2z" />
            </svg>
            Allergies
          </h3>
          <div class="info-card">
            {% if patient.allergies %}
            <div class="info-section">
              <div class="info-item">
                <div class="item-icon">‚ö†Ô∏è</div>
                <span>{{ patient.allergies }}</span>
              </div>
            </div>
            {% else %}
            <div class="info-empty">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4M12 8h.01" />
              </svg>
              <span>No allergies recorded</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Family History Tab -->
        <div id="family_history" class="table-container" style="display: none">
          <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
              <circle cx="9" cy="7" r="4" />
              <path d="M23 21v-2a4 4 0 0 1-3-3.87" />
              <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
            Family History
          </h3>
          <div class="info-card">
            {% if patient.family_history %}
            <div class="info-section">
              <div class="info-item">
                <div class="item-icon">üë•</div>
                <span>{{ patient.family_history }}</span>
              </div>
            </div>
            {% else %}
            <div class="info-empty">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4M12 8h.01" />
              </svg>
              <span>No family history recorded</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Medications Tab -->
        <div id="medications" class="table-container" style="display: none">
          <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
            </svg>
            Current Medications
          </h3>
          <div class="info-card">
            {% if patient.medications %}
            <div class="info-section">
              <div class="info-item">
                <div class="item-icon">üíä</div>
                <div class="medication-details">
                  <span style="white-space: pre-line">{{ patient.medications }}</span>
                </div>
              </div>
            </div>
            {% else %}
            <div class="info-empty">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3v18m0 0l3-3m-3 3l-3-3M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <span>No medications recorded</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Pharmacy Tab -->
        <div id="pharmacy" class="table-container" style="display: none">
          <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 8V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v3" />
              <path d="M19 16v3a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3" />
              <path d="M3 8h18" />
              <path d="M9 12h6" />
            </svg>
            Pharmacy Information
          </h3>
          <div class="info-card">
            {% if patient.pharmacy_info %}
            <div class="info-section">
              <div class="info-item">
                <div class="item-icon">üè•</div>
                <span>{{ patient.pharmacy_info }}</span>
              </div>
            </div>
            {% else %}
            <div class="info-empty">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4M12 8h.01" />
              </svg>
              <span>No pharmacy information recorded</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <div class="medical-history-section">
        <div class="section-header">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            class="header-icon">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
          </svg>
          Past Medical History
        </div>
        <div class="pmh-list">
          {% if patient.medical_history.all %}
          {% for condition in patient.medical_history.all %}
          <div class="pmh-item">
            <div class="condition-marker"></div>
            <span>{{ condition.pmh }}</span>
          </div>
          {% endfor %}
          {% else %}
          <div class="pmh-empty">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 16v-4M12 8h.01" />
            </svg>
            <span>No past medical history recorded</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if moderator and not patient.is_escalated %}
  <div class="table-container mt-8 max-w-lg mx-auto">
  <h3 class="flex items-center gap-2 text-white text-xl font-semibold mb-4">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm1-9h-2v6h2zm0-4h-2v2h2z" />
    </svg>
    Escalate Patient to Doctor
  </h3>
  <form method="post" action="{% url 'escalate_patient' patient.id %}" class="flex flex-col sm:flex-row gap-4 items-center">
    {% csrf_token %}
    <div class="flex flex-col gap-2 w-full sm:w-2/3">
      <label for="doctor" class="text-[15px] font-medium text-white mb-1">Select Doctor:</label>
      <div class="relative">
        <select name="doctor_id" id="doctor" required
          class="block w-full px-4 py-3 pr-10 rounded-lg bg-[rgba(255,255,255,0.10)] border border-[rgba(255,255,255,0.18)] text-white text-[15px] focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all appearance-none">
          {% for doctor in doctors %}
            <option value="{{ doctor.id }}" class="text-black">
              {{ doctor.user.username }} - {{ doctor.user.first_name }} {{ doctor.user.last_name }}{% if doctor.specialization %} ({{ doctor.specialization }}){% endif %}
            </option>
          {% endfor %}
        </select>
        <svg class="pointer-events-none absolute right-3 top-1/2 transform -translate-y-1/2 text-white opacity-70" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </div>
    </div>
    <button type="submit"
      class="mt-4 sm:mt-7 px-6 py-3 rounded-lg bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white font-semibold shadow-lg hover:scale-105 transition-all">
      Escalate
    </button>
  </form>
</div>
  {% endif %}

  <script>
    function showTab(tabId) {
      console.log('showTab called with:', tabId); // Debug log
      const tabs = document.querySelectorAll(".table-container");
      const tabButtons = document.querySelectorAll(".tabs div");

      tabs.forEach((tab) => (tab.style.display = "none"));
      tabButtons.forEach((button) => button.classList.remove("active"));

      const targetTab = document.getElementById(tabId);
      if (targetTab) {
        targetTab.style.display = "block";
      } else {
        console.error('Tab not found:', tabId); // Debug log
      }
      
      // Find the tab button by matching onclick attribute and set it as active
      tabButtons.forEach((button) => {
        if (button.getAttribute('onclick') && button.getAttribute('onclick').includes(`'${tabId}'`)) {
          button.classList.add("active");
        }
      });

      // Load documentation automatically when documentation tab is opened
      if (tabId === "documentation") {
        // Only load if not already loaded
        if (!window.documentationsLoaded) {
          fetchDocumentation();
          window.documentationsLoaded = true;
        }
      }
    }

    function fetchDocumentation() {
  const docListContainer = document.getElementById("documentation-list");
  docListContainer.innerHTML = "<div style='padding: 15px; text-align: center;'>Loading documentation...</div>";

  const docDetailsContainer = document.getElementById("documentation-details");
  docDetailsContainer.innerHTML = `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.5);">
      <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-bottom: 15px; opacity: 0.5;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <p>Select a document to view details</p>
    </div>
  `;

  const patientId = "{{ patient.id }}";
  let url = `/view_documentation/${patientId}/`;

  fetch(url, {
    method: 'GET',
    credentials: 'same-origin',
    headers: {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then((response) => response.json())
  .then((data) => {
    if (!data.documentations || data.documentations.length === 0) {
      docListContainer.innerHTML = "<div style='padding: 15px; text-align: center;'>No documentation found.</div>";
    } else {
      window.documentations = data.documentations;
      window.patientDocumentations = data.documentations;
      let listContent = '';
      data.documentations.forEach((doc, index) => {
        const createdAtDate = new Date(doc.created_at);
        const formattedCreatedAt = `${String(createdAtDate.getMonth() + 1).padStart(2, '0')}/${String(createdAtDate.getDate()).padStart(2, '0')}/${createdAtDate.getFullYear()}`;
        listContent += `
          <div class="doc-item" data-index="${index}" style="padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;">
            <h4 style="color: white; font-size: 16px; margin-bottom: 5px;">${doc.title}</h4>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin: 3px 0;">
              ${doc.written_by}                   
            </p>
            <p style="color: rgba(255, 255, 255, 0.5); font-size: 12px; margin-top: 8px;">
              Date of Service: ${formattedCreatedAt}
            </p>
          </div>
        `;
      });
      docListContainer.innerHTML = listContent;
      document.querySelectorAll('.doc-item').forEach(item => {
        item.addEventListener('click', function () {
          document.querySelectorAll('.doc-item').forEach(i => {
            i.style.background = '';
            i.style.borderLeft = '';
          });
          this.style.background = 'rgba(121, 40, 202, 0.2)';
          this.style.borderLeft = '4px solid #7928CA';
          const index = this.getAttribute('data-index');
          const doc = window.documentations[index];
          displayDocumentationDetails(doc);
        });
      });

      // Select the first document by default
      if (document.querySelector('.doc-item')) {
        document.querySelector('.doc-item').click();
      }
    }
  })
  .catch((error) => {
    console.error("Error fetching documentation:", error);
    docListContainer.innerHTML = `<div style='padding: 15px; text-align: center; color: #FF4E4E;'>Error: ${error.message}</div>`;
  });
}

    // Toggle share menu visibility - with proper event stopping
    function toggleShareMenu(docId) {
      event.stopPropagation(); // Stop event from bubbling up
    
      const menu = document.getElementById(`share-menu-${docId}`);
    
      // Close all other menus first
      document.querySelectorAll('[id^="share-menu-"]').forEach(m => {
        if (m.id !== `share-menu-${docId}`) {
          m.style.display = 'none';
          m.style.pointerEvents = 'none';
        }
      });
    
      if (menu.style.display === 'none' || !menu.style.display) {
        menu.style.display = 'block';
        menu.style.pointerEvents = 'auto';
      } else {
        menu.style.display = 'none';
        menu.style.pointerEvents = 'none';
      }
    }

    function displayDocumentationDetails(doc) {
      // Store the current documentation for PDF export
      window.currentDocumentation = doc;
      
      const docDetailsContainer = document.getElementById("documentation-details");

      const createdAtDate = new Date(doc.created_at);
      const formattedCreatedAt = `${String(createdAtDate.getMonth() + 1).padStart(2, '0')}/${String(createdAtDate.getDate()).padStart(2, '0')}/${createdAtDate.getFullYear()} ${String(createdAtDate.getHours()).padStart(2, '0')}:${String(createdAtDate.getMinutes()).padStart(2, '0')}:${String(createdAtDate.getSeconds()).padStart(2, '0')}`;

      const updatedAtDate = new Date(doc.updated_at);
      const formattedUpdatedAt = `${String(updatedAtDate.getMonth() + 1).padStart(2, '0')}/${String(updatedAtDate.getDate()).padStart(2, '0')}/${updatedAtDate.getFullYear()} ${String(updatedAtDate.getHours()).padStart(2, '0')}:${String(updatedAtDate.getMinutes()).padStart(2, '0')}:${String(updatedAtDate.getSeconds()).padStart(2, '0')}`;

      let detailContent = `
          <div style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 15px; margin-bottom: 15px;">
              <h2 style="color: white; font-size: 22px; margin-bottom: 10px;">${doc.title}</h2>
              <div style="display: flex; gap: 10px;">
                <div style="position: relative;">
                  <button onclick="toggleShareMenu(${doc.id}); return false;" id="share-btn-${doc.id}" style="background: #7928CA; color: white; border: none; border-radius: 6px; padding: 8px 18px; font-size: 14px; cursor: pointer; transition: background-color 0.2s ease;">
                    <i class="fas fa-share-alt"></i> Share as PDF <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 12px;"></i>
                  </button>
                  <div id="share-menu-${doc.id}" style="display: none; pointer-events: none; position: absolute; top: 100%; left: 0; background: #2a2a3e; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; min-width: 200px; z-index: 1000; box-shadow: 0 8px 20px rgba(0,0,0,0.3);">
                    <div onclick="downloadPDF(${doc.id}); event.stopPropagation();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); color: white; font-size: 14px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                      <i class="fas fa-download" style="margin-right: 8px; color: #7928CA;"></i> Download PDF
                    </div>
                    <div onclick="shareViaEmail(${doc.id}); event.stopPropagation();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); color: white; font-size: 14px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                      <i class="fas fa-envelope" style="margin-right: 8px; color: #FF0080;"></i> Share via Email
                    </div>
                    <div onclick="copyShareableLink(${doc.id}); event.stopPropagation();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); color: white; font-size: 14px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                      <i class="fas fa-link" style="margin-right: 8px; color: #00CC88;"></i> Copy Shareable Link
                    </div>
                    <div onclick="previewPDF(${doc.id}); event.stopPropagation();" style="padding: 12px 16px; cursor: pointer; color: white; font-size: 14px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                      <i class="fas fa-eye" style="margin-right: 8px; color: #FFA500;"></i> Preview PDF
                    </div>
                  </div>
                </div>
                <button onclick="window.location.href='/reports/edit-documentation/${doc.id}/'" style="background: #FF0080; color: white; border: none; border-radius: 6px; padding: 8px 18px; font-size: 14px; cursor: pointer; transition: background-color 0.2s ease;">Edit</button>
              </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 15px;">
              <span><strong>Date of Service:</strong> ${doc.doc_report_date}</span>
              <span><strong>Updated:</strong> ${formattedUpdatedAt}</span>
            </div>
        `;

    // Display the full documentation content under a single heading
    if (doc.history_of_present_illness) {
      detailContent += `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #FF0080; font-size: 16px; margin-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 5px;">Documentation</h3>
              <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.5; white-space: pre-wrap;">${doc.history_of_present_illness}</p>
            </div>
          `;
    }

    detailContent += '</div>';
    docDetailsContainer.innerHTML = detailContent;
  }

  // Function to fetch and display reports in the vitals table
  function fetchAndDisplayReports(patientId) {
    fetch(`/reports/get-all-reports/${patientId}/`)
      .then(response => response.json())
      .then(data => {
        if (!data.reports || data.reports.length === 0) {
          console.log("No reports found for this patient");
          // Show empty state message
          const tableBody = document.querySelector('#results table tbody');
          tableBody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px;">No vital signs data available</td></tr>';
          return;
        }

        console.log("Reports found:", data.reports.length);

        // Get the table elements
        const tableHeader = document.querySelector('#results table thead tr');
        const tableBody = document.querySelector('#results table tbody');
        
        // Clear existing content
        tableBody.innerHTML = '';

        // Define vital signs to display
        const vitalSigns = [
          { name: 'Systolic BP (mmHg)', key: 'systolic_blood_pressure', fallback: 'blood_pressure' },
          { name: 'Diastolic BP (mmHg)', key: 'diastolic_blood_pressure' },
          { name: 'Heart Rate (bpm)', key: 'pulse', fallback: 'heart_rate' },
          { name: 'SpO2 (%)', key: 'spo2' },
          { name: 'Temperature (¬∞F)', key: 'temperature' },
          { name: 'Blood Glucose', key: 'blood_glucose' }
        ];

        // Create rows for each vital sign
        vitalSigns.forEach(vital => {
          const row = document.createElement('tr');
          const firstCell = document.createElement('td');
          firstCell.className = 'fixed-left';
          firstCell.style.fontWeight = '600';
          firstCell.style.color = '#FF0080';
          firstCell.textContent = vital.name;
          row.appendChild(firstCell);

          // Add cells for each report
          data.reports.forEach(report => {
            const cell = document.createElement('td');
            let value = report[vital.key];
            
            // Try fallback key if primary key is empty
            if ((!value || value === '') && vital.fallback) {
              value = report[vital.fallback];
            }
            
            // Handle blood pressure display
            if (vital.key === 'systolic_blood_pressure' && report.blood_pressure && report.blood_pressure.includes('/')) {
              value = report.blood_pressure.split('/')[0];
            } else if (vital.key === 'diastolic_blood_pressure' && report.blood_pressure && report.blood_pressure.includes('/')) {
              value = report.blood_pressure.split('/')[1];
            }
            
            cell.textContent = value || '---';
            cell.style.textAlign = 'center';
            
            // Add color coding for abnormal values
            if (value && value !== '---') {
              if (vital.key === 'systolic_blood_pressure' && parseInt(value) > 140) {
                cell.style.color = '#FF4E4E';
                cell.style.fontWeight = '600';
              } else if (vital.key === 'pulse' || vital.key === 'heart_rate') {
                const hr = parseInt(value);
                if (hr > 100 || hr < 60) {
                  cell.style.color = '#FF4E4E';
                  cell.style.fontWeight = '600';
                }
              } else if (vital.key === 'spo2' && parseInt(value) < 95) {
                cell.style.color = '#FF4E4E';
                cell.style.fontWeight = '600';
              }
            }
            
            row.appendChild(cell);
          });

          tableBody.appendChild(row);
        });

        // Update the table header with dates
        // Keep the first header cell (Vital Signs)
        const firstHeader = tableHeader.querySelector('th');
        tableHeader.innerHTML = '';
        tableHeader.appendChild(firstHeader);

        // Add new header cells with dates
        data.reports.forEach(report => {
          const date = new Date(report.created_at);
          const formattedDate = `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
          const formattedTime = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
          
          const th = document.createElement('th');
          th.innerHTML = `${formattedDate}<br><small style="font-size: 12px; opacity: 0.8;">${formattedTime}</small>`;
          th.style.textAlign = 'center';
          th.style.minWidth = '100px';
          tableHeader.appendChild(th);
        });

        console.log("Reports table updated successfully");
      })
      .catch(error => {
        console.error("Error fetching reports:", error);
        const tableBody = document.querySelector('#results table tbody');
        tableBody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #FF4E4E; padding: 40px;">Error loading vital signs data</td></tr>';
      });
  }

  // Call this function when the page loads
  document.addEventListener('DOMContentLoaded', function () {
    // Get the patient ID from the template
    const patientId = "{{ patient.id }}";
    fetchAndDisplayReports(patientId);

    // Hide share menus when clicking anywhere else (but not on tabs)
    document.addEventListener('click', function (e) {
      // Don't close menus if clicking on tabs or tab buttons
      if (!e.target.closest('.tabs') && !e.target.closest('[id^="share-"]')) {
        document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
          menu.style.display = 'none';
          menu.style.pointerEvents = 'none';
        });
      }
    });
  });

  // Replace the placeholder functions with these working implementations:

  // Helper function to find documentation by ID
  function findDocumentationById(docId) {
    if (window.patientDocumentations) {
      return window.patientDocumentations.find(doc => doc.id == docId);
    }
    if (window.currentDocumentation && window.currentDocumentation.id == docId) {
      return window.currentDocumentation;
    }
    return null;
  }

  // Helper function to get patient info
  function getPatientInfo() {
    const patientName = document.querySelector('.patient-details span')?.textContent || 'Unknown Patient';
    const dobElement = document.querySelector('.patient-details div:nth-child(2) span');
    const patientDOB = dobElement ? dobElement.textContent : 'Unknown DOB';
    
    return { name: patientName, dob: patientDOB };
  }

  // Show notification to user
  function showNotification(message, type = 'success') {
    // Remove any existing notifications
    const existingNotification = document.getElementById('pdf-notification');
    if (existingNotification) {
      existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.id = 'pdf-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#00CC88' : '#FF4E4E'};
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      font-size: 14px;
      max-width: 300px;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
      if (notification) {
        notification.remove();
      }
    }, 3000);
  }

    // 1. Download PDF function
    function downloadPDF(docId) {
      const doc = findDocumentationById(docId);
      if (!doc) {
        showNotification('Documentation not found', 'error');
        return;
      }

      const patientInfo = getPatientInfo();
      
      // Create a new window with the PDF content
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Medical Documentation - ${doc.title}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
            .header { border-bottom: 3px solid #7928CA; padding-bottom: 20px; margin-bottom: 30px; }
            .patient-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
            .doc-content { margin-bottom: 30px; }
            .signature-section { margin-top: 50px; border-top: 1px solid #ddd; padding-top: 30px; }
            .signature-line { border-bottom: 1px solid #000; width: 300px; height: 30px; margin: 20px 0; }
            h1 { color: #7928CA; margin: 0; }
            h2 { color: #FF0080; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .date { color: #666; font-size: 14px; }
            @media print { 
              body { margin: 20px; } 
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>RPM - Remote Patient Monitoring</h1>
            <p class="date">Generated on: ${new Date().toLocaleString()}</p>
          </div>
          
          <div class="patient-info">
            <h2>Patient Information</h2>
            <p><strong>Name:</strong> ${patientInfo.name}</p>
            <p><strong>Date of Birth:</strong> ${patientInfo.dob}</p>
            <p><strong>Date of Service:</strong> ${new Date(doc.created_at).toLocaleDateString()}</p>
          </div>
          
          <div class="doc-content">
            <h2>${doc.title}</h2>
            <div style="white-space: pre-wrap; font-size: 14px; line-height: 1.8;">
              ${doc.history_of_present_illness || 'No documentation content available.'}
            </div>
          </div>
          
          <div class="signature-section">
            <p><strong>Provider:</strong> ${doc.written_by}</p>
            <p><strong>Date:</strong> ${new Date(doc.updated_at).toLocaleDateString()}</p>
            
            <div style="margin-top: 40px;">
              <p>Provider Signature:</p>
              <div class="signature-line"></div>
            </div>
          </div>
          
          <div class="no-print" style="margin-top: 30px; text-align: center;">
            <button onclick="window.print()" style="background: #7928CA; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Print/Save as PDF</button>
            <button onclick="window.close()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Close</button>
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // Auto-trigger print dialog after a short delay
      setTimeout(() => {
        printWindow.print();
      }, 500);
      
      showNotification('PDF preview opened. Use your browser\'s print function to save as PDF.');
    }

    // 2. Share via Email function
    function shareViaEmail(docId) {
      const doc = findDocumentationById(docId);
      if (!doc) {
        showNotification('Documentation not found', 'error');
        return;
      }
      const patientInfo = getPatientInfo();
      const subject = `Medical Documentation: ${doc.title} - ${patientInfo.name}`;
      const link = `${window.location.origin}/documentation/${docId}/view/`;
      const body = `Dear Colleague,\n\nPlease find the medical documentation details below:\n\nPatient: ${patientInfo.name}\nDate of Birth: ${patientInfo.dob}\nDate of Service: ${new Date(doc.created_at).toLocaleDateString()}\nDocument Title: ${doc.title}\nProvider: ${doc.written_by}\n\nDocumentation Link: ${link}\n\n---\nThis document was generated from RPM - Remote Patient Monitoring System\nGenerated on: ${new Date().toLocaleString()}\n\nBest regards,\nRPM Healthcare Team`;
      const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoLink;
      showNotification('Email client opened with documentation link.');
    }

    // 3. Copy Shareable Link function
    function copyShareableLink(docId) {
      const doc = findDocumentationById(docId);
      if (!doc) {
        showNotification('Documentation not found', 'error');
        return;
      }
      // Use a real, accessible link (adjust as needed for your backend)
      const shareableLink = `${window.location.origin}/documentation/${docId}/view/`;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(shareableLink).then(() => {
          showNotification('Shareable link copied to clipboard!');
        }).catch(() => {
          fallbackCopyToClipboard(shareableLink);
        });
      } else {
        fallbackCopyToClipboard(shareableLink);
      }
    }

    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showNotification('Shareable link copied to clipboard!');
      } catch (err) {
        showNotification('Failed to copy link. Please copy manually: ' + text, 'error');
      }
      document.body.removeChild(textArea);
    }

    // 4. Preview PDF function
    function previewPDF(docId) {
      const doc = findDocumentationById(docId);
      if (!doc) {
        showNotification('Documentation not found', 'error');
        return;
      }

      const patientInfo = getPatientInfo();
      
      // Create a professional PDF preview in a new tab
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>PDF Preview - ${doc.title}</title>
          <style>
            body { 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
              margin: 0; 
              background: #f5f5f5; 
              padding: 20px;
            }
            .preview-container { 
              max-width: 800px; 
              margin: 0 auto; 
              background: white; 
              box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
              border-radius: 8px;
              overflow: hidden;
            }
            .toolbar {
              background: #7928CA;
              color: white;
              padding: 15px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            .content { 
              padding: 40px; 
              line-height: 1.8; 
              color: #333; 
            }
            .header { 
              border-bottom: 3px solid #7928CA; 
              padding-bottom: 20px; 
              margin-bottom: 30px; 
              text-align: center;
            }
            .patient-info { 
              background: #f8f9fa; 
              padding: 20px; 
              border-radius: 8px; 
              margin-bottom: 30px;
              border-left: 4px solid #FF0080;
            }
            .doc-content { 
              margin-bottom: 30px; 
              background: #fafafa;
              padding: 20px;
              border-radius: 8px;
            }
            .signature-section { 
              margin-top: 50px; 
              border-top: 2px solid #eee; 
              padding-top: 30px; 
            }
            h1 { color: #7928CA; margin: 0; font-size: 28px; }
            h2 { color: #FF0080; border-bottom: 2px solid #eee; padding-bottom: 10px; }
            .date { color: #666; font-size: 14px; margin-top: 10px; }
            .btn {
              background: #7928CA;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
              margin-right: 10px;
              font-size: 14px;
            }
            .btn:hover { background: #6A0DAD; }
            .btn.secondary { background: #666; }
            .btn.secondary:hover { background: #555; }
          </style>
        </head>
        <body>
          <div class="preview-container">
            <div class="toolbar">
              <h3 style="margin: 0;">PDF Preview - ${doc.title}</h3>
              <div>
                <button class="btn" onclick="window.print()">üìÑ Print/Save PDF</button>
                <button class="btn secondary" onclick="window.close()">‚úï Close</button>
              </div>
            </div>
            
            <div class="content">
              <div class="header">
                <h1>RPM - Remote Patient Monitoring</h1>
                <p class="date">Medical Documentation Report</p>
                <p class="date">Generated on: ${new Date().toLocaleString()}</p>
              </div>
              
              <div class="patient-info">
                <h2>üìã Patient Information</h2>
                <p><strong>Patient Name:</strong> ${patientInfo.name}</p>
                <p><strong>Date of Birth:</strong> ${patientInfo.dob}</p>
                <p><strong>Date of Service:</strong> ${new Date(doc.created_at).toLocaleDateString()}</p>
                <p><strong>Document ID:</strong> #${doc.id}</p>
              </div>
              
              <div class="doc-content">
                <h2>üìù ${doc.title}</h2>
                <div style="white-space: pre-wrap; font-size: 15px; line-height: 1.8; color: #444;">
                  ${doc.history_of_present_illness || 'No documentation content available.'}
                </div>
              </div>
              
              <div class="signature-section">
                <h2>üë®‚Äç‚öïÔ∏è Provider Information</h2>
                <p><strong>Provider:</strong> ${doc.written_by}</p>
                <p><strong>Created:</strong> ${new Date(doc.created_at).toLocaleString()}</p>
                <p><strong>Last Updated:</strong> ${new Date(doc.updated_at).toLocaleString()}</p>
                
                <div style="margin-top: 40px; border: 1px dashed #ccc; padding: 20px; background: #f9f9f9;">
                  <p><strong>Digital Signature Section</strong></p>
                  <p style="color: #666; font-size: 14px;">Provider Signature: ________________________</p>
                  <p style="color: #666; font-size: 14px;">Date: ________________________</p>
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 40px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
                <p style="color: #666; font-size: 12px; margin: 0;">
                  This document was generated from RPM - Remote Patient Monitoring System<br>
                  For questions or concerns, please contact our support team.
                </p>
              </div>
            </div>
          </div>
        </body>
        </html>
      `);
      
      previewWindow.document.close();
      showNotification('PDF preview opened in new tab.');
    }

    // Close share menu when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('[id^="share-btn-"]')) {
        document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
          menu.style.display = 'none';
          menu.style.pointerEvents = 'none';
        });
      }
    });

    // Report Management Functions
    let currentEditingReportId = null;
    const patientId = "{{ patient.id }}";

    // Show form-specific messages
    function showFormMessage(message, type = 'info') {
      // Remove any existing form messages
      const existingMessage = document.querySelector('.form-message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'form-message';
      messageDiv.style.cssText = `
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 14px;
        font-weight: 500;
        ${type === 'success' ? 'background: rgba(0, 204, 136, 0.2); color: #00CC88; border: 1px solid rgba(0, 204, 136, 0.3);' : 
          type === 'error' ? 'background: rgba(255, 78, 78, 0.2); color: #FF4E4E; border: 1px solid rgba(255, 78, 78, 0.3);' :
          'background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.2);'}
      `;
      messageDiv.textContent = message;
      
      const dropdownContainer = document.querySelector('.dropdown-container');
      if (dropdownContainer) {
        dropdownContainer.appendChild(messageDiv);
        
        // Auto-remove after 3 seconds for success/info messages
        if (type !== 'error') {
          setTimeout(() => {
            if (messageDiv) {
              messageDiv.remove();
            }
          }, 3000);
        }
      }
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = type === 'success' ? 
        'linear-gradient(135deg, #00CC88, #7928CA)' : 
        'linear-gradient(135deg, #FF4E4E, #FF0080)';
      notification.style.transform = 'translateX(0)';
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
      }, 3000);
    }

    // Clear form errors
    function clearFormErrors(formPrefix) {
      document.querySelectorAll(`[id^="${formPrefix}-"][id$="-error"]`).forEach(error => {
        error.textContent = '';
      });
    }

    // Display form errors
    function displayFormErrors(errors, formPrefix) {
      Object.keys(errors).forEach(field => {
        const errorElement = document.getElementById(`${formPrefix}-${field.replace('_', '-')}-error`);
        if (errorElement) {
          errorElement.textContent = errors[field];
        }
      });
    }

    // CSRF Token
    function getCsrfToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Open Edit Modal
    async function openEditModal() {
      const modal = document.getElementById('edit-report-modal');
      const select = document.getElementById('report-select');
      const editBtn = document.getElementById('edit-report-btn');
      const formContainer = document.getElementById('edit-form-container');
      const saveBtn = document.getElementById('save-edit-btn');
      
      // Check if button is disabled
      if (editBtn.disabled) {
        showNotification('No reports available to edit', 'error');
        return;
      }
      
      // Initialize form state - disabled until report is selected
      formContainer.style.opacity = '0.5';
      formContainer.style.pointerEvents = 'none';
      saveBtn.disabled = true;
      
      // Clear any previous form data
      document.getElementById('edit-report-form').reset();
      clearFormErrors('edit');
      currentEditingReportId = null;
      
      // Show loading in dropdown
      select.innerHTML = '<option value="">Loading reports...</option>';
      modal.classList.add('active');
      
      try {
        const response = await fetch(`/reports/get-recent-reports/${patientId}/`);
        const data = await response.json();
        
        if (data.success && data.reports.length > 0) {
          select.innerHTML = '<option value="">Select a report to edit...</option>';
          data.reports.forEach(report => {
            const option = document.createElement('option');
            option.value = report.id;
            
            // Create a more readable display format
            const date = new Date(report.created_at).toLocaleDateString();
            const time = new Date(report.created_at).toLocaleTimeString();
            
            // Extract key vitals for display
            const systolic = report.data.systolic_blood_pressure || '---';
            const diastolic = report.data.diastolic_blood_pressure || '---';
            const pulse = report.data.pulse || report.data.heart_rate || '---';
            
            option.textContent = `${date} ${time} - BP: ${systolic}/${diastolic}, Pulse: ${pulse}`;
            option.dataset.reportData = JSON.stringify(report.data);
            select.appendChild(option);
          });
          
          showFormMessage('Select a report from the dropdown above to begin editing.', 'info');
        } else {
          select.innerHTML = '<option value="">No recent reports available</option>';
          showFormMessage('No recent reports found to edit.', 'error');
        }
      } catch (error) {
        console.error('Error loading reports:', error);
        select.innerHTML = '<option value="">Error loading reports</option>';
        showFormMessage('Error loading reports. Please try again.', 'error');
      }
    }

    // Populate edit form
    function populateEditForm(reportData) {
      document.getElementById('edit-systolic').value = reportData.systolic_blood_pressure || '';
      document.getElementById('edit-diastolic').value = reportData.diastolic_blood_pressure || '';
      document.getElementById('edit-pulse').value = reportData.pulse || reportData.heart_rate || '';
      document.getElementById('edit-spo2').value = reportData.spo2 || '';
      document.getElementById('edit-temperature').value = reportData.temperature || '';
      document.getElementById('edit-glucose').value = reportData.blood_glucose || '';
      document.getElementById('edit-irregular').value = reportData.irregular_heartbeat || '';
    }

    // Close Edit Modal
    function closeEditModal() {
      document.getElementById('edit-report-modal').classList.remove('active');
      document.getElementById('edit-report-form').reset();
      clearFormErrors('edit');
      currentEditingReportId = null;
      
      // Reset form state
      const formContainer = document.getElementById('edit-form-container');
      const saveBtn = document.getElementById('save-edit-btn');
      formContainer.style.opacity = '0.5';
      formContainer.style.pointerEvents = 'none';
      saveBtn.disabled = true;
      
      // Remove any form messages
      const formMessage = document.querySelector('.form-message');
      if (formMessage) {
        formMessage.remove();
      }
    }

    // Open Add Modal
    function openAddModal() {
      document.getElementById('add-report-modal').classList.add('active');
    }

    // Close Add Modal
    function closeAddModal() {
      document.getElementById('add-report-modal').classList.remove('active');
      document.getElementById('add-report-form').reset();
      clearFormErrors('add');
    }

    // Handle report selection for editing - with null check
    function setupReportSelectListener() {
      const reportSelect = document.getElementById('report-select');
      if (reportSelect) {
        reportSelect.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const formContainer = document.getElementById('edit-form-container');
          const saveBtn = document.getElementById('save-edit-btn');
          
          if (selectedOption.value && selectedOption.dataset.reportData) {
            // Enable the form
            formContainer.style.opacity = '1';
            formContainer.style.pointerEvents = 'auto';
            saveBtn.disabled = false;
            
            // Populate the form
            currentEditingReportId = selectedOption.value;
            const reportData = JSON.parse(selectedOption.dataset.reportData);
            populateEditForm(reportData);
            clearFormErrors('edit');
            
            // Show success message
            showFormMessage('Form populated with report data. You can now edit the values.', 'success');
          } else {
            // Disable the form
            formContainer.style.opacity = '0.5';
            formContainer.style.pointerEvents = 'none';
            saveBtn.disabled = true;
            
            // Clear the form
            currentEditingReportId = null;
            const editForm = document.getElementById('edit-report-form');
            if (editForm) {
              editForm.reset();
            }
            clearFormErrors('edit');
            
            if (this.value === '') {
              showFormMessage('Please select a report to edit.', 'info');
            }
          }
        });
      }
    }

    // Handle Edit Form Submission - with null check
    function setupEditFormListener() {
      const editForm = document.getElementById('edit-report-form');
      if (editForm) {
        editForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!currentEditingReportId) {
            showNotification('Please select a report to edit', 'error');
            return;
          }

          const submitBtn = document.getElementById('save-edit-btn');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
          submitBtn.disabled = true;
      
      clearFormErrors('edit');

      // Helper function to safely parse numeric values
      function parseNumericValue(value, isInteger = false) {
        if (!value || value === '') return null;
        const parsed = parseFloat(value);
        return isNaN(parsed) ? null : (isInteger ? Math.round(parsed) : parsed);
      }

      const formData = {
        systolic_blood_pressure: parseNumericValue(document.getElementById('edit-systolic').value, true),
        diastolic_blood_pressure: parseNumericValue(document.getElementById('edit-diastolic').value, true),
        pulse: parseNumericValue(document.getElementById('edit-pulse').value, true),
        spo2: parseNumericValue(document.getElementById('edit-spo2').value, true),
        temperature: parseNumericValue(document.getElementById('edit-temperature').value),
        blood_glucose: parseNumericValue(document.getElementById('edit-glucose').value, true),
        irregular_heartbeat: document.getElementById('edit-irregular').value || null
      };

      try {
        const response = await fetch(`/reports/update-report/${currentEditingReportId}/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Report updated successfully!');
          closeEditModal();
          // Refresh the vitals table
          fetchAndDisplayReports(patientId);
        } else {
          if (data.errors) {
            displayFormErrors(data.errors, 'edit');
          } else {
            showNotification(data.error || 'Failed to update report', 'error');
          }
        }
      } catch (error) {
        console.error('Error updating report:', error);
        showNotification('Error updating report', 'error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
        });
      }
    }

    // Handle Add Form Submission - with null check
    function setupAddFormListener() {
      const addForm = document.getElementById('add-report-form');
      if (addForm) {
        addForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const submitBtn = document.getElementById('save-add-btn');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span class="loading-spinner"></span> Adding...';
          submitBtn.disabled = true;
      
      clearFormErrors('add');

      // Helper function to safely parse numeric values
      function parseNumericValue(value, isInteger = false) {
        if (!value || value === '') return null;
        const parsed = parseFloat(value);
        return isNaN(parsed) ? null : (isInteger ? Math.round(parsed) : parsed);
      }

      const formData = {
        patient_id: patientId,
        systolic_blood_pressure: parseNumericValue(document.getElementById('add-systolic').value, true),
        diastolic_blood_pressure: parseNumericValue(document.getElementById('add-diastolic').value, true),
        pulse: parseNumericValue(document.getElementById('add-pulse').value, true),
        spo2: parseNumericValue(document.getElementById('add-spo2').value, true),
        temperature: parseNumericValue(document.getElementById('add-temperature').value),
        blood_glucose: parseNumericValue(document.getElementById('add-glucose').value, true),
        irregular_heartbeat: document.getElementById('add-irregular').value || null
      };

      try {
        const response = await fetch('/reports/create-report-manual/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Report added successfully!');
          closeAddModal();
          // Refresh the vitals table
          fetchAndDisplayReports(patientId);
        } else {
          if (data.errors) {
            displayFormErrors(data.errors, 'add');
          } else {
            showNotification(data.error || 'Failed to add report', 'error');
          }
        }
      } catch (error) {
        console.error('Error adding report:', error);
        showNotification('Error adding report', 'error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
        });
      }
    }

    // Event listeners for toolbar buttons - ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Setting up button event listeners'); // Debug log
      
      // Attach event listeners
      const editBtn = document.getElementById('edit-report-btn');
      const addBtn = document.getElementById('add-report-btn');
      
      console.log('Edit button found:', !!editBtn); // Debug log
      console.log('Add button found:', !!addBtn); // Debug log
      
      if (editBtn) {
        editBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Edit button clicked - event triggered'); // Debug log
          openEditModal();
        });
        console.log('Edit button event listener attached'); // Debug log
      }
      
      if (addBtn) {
        addBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Add button clicked - event triggered'); // Debug log
          openAddModal();
        });
        console.log('Add button event listener attached'); // Debug log
      }
      
      // Initial call to set button states
      updateToolbarButtons();
      
      // Setup form event listeners
      setupReportSelectListener();
      setupEditFormListener();
      setupAddFormListener();
      setupModalOverlayListeners();
    });

    // Close modals on overlay click - with null check
    function setupModalOverlayListeners() {
      const modalOverlays = document.querySelectorAll('.modal-overlay');
      if (modalOverlays.length > 0) {
        modalOverlays.forEach(overlay => {
          overlay.addEventListener('click', function(e) {
            if (e.target === this) {
              if (this.id === 'edit-report-modal') {
                closeEditModal();
              } else if (this.id === 'add-report-modal') {
                closeAddModal();
              }
            }
          });
        });
      }
    }

    // Enable/disable edit button based on data availability
    function updateToolbarButtons() {
      const editBtn = document.getElementById('edit-report-btn');
      const addBtn = document.getElementById('add-report-btn');
      const hasData = document.querySelector('#results table tbody tr:not(.no-data)');
      
      console.log('updateToolbarButtons called, hasData:', !!hasData); // Debug log
      
      // Edit button - enable only if there's data
      if (editBtn) {
        if (hasData) {
          editBtn.style.opacity = '1';
          editBtn.disabled = false;
          editBtn.style.pointerEvents = 'auto';
        } else {
          editBtn.style.opacity = '0.5';
          editBtn.disabled = true;
          editBtn.style.pointerEvents = 'none';
        }
      }
      
      // Add button - always enabled
      if (addBtn) {
        addBtn.style.opacity = '1';
        addBtn.disabled = false;
        addBtn.style.pointerEvents = 'auto';
      }
    }

    // Call updateToolbarButtons when reports are loaded
    const originalFetchAndDisplayReports = fetchAndDisplayReports;
    if (typeof fetchAndDisplayReports === 'function') {
      window.fetchAndDisplayReports = function(patientId) {
        originalFetchAndDisplayReports(patientId);
        setTimeout(updateToolbarButtons, 100); // Small delay to ensure DOM is updated
      };
    }

    // Initial call to set button states
    document.addEventListener('DOMContentLoaded', updateToolbarButtons);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Escape key to close modals
      if (e.key === 'Escape') {
        if (document.getElementById('edit-report-modal').classList.contains('active')) {
          closeEditModal();
        }
        if (document.getElementById('add-report-modal').classList.contains('active')) {
          closeAddModal();
        }
      }
      
      // Ctrl+E to open edit modal
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        openEditModal();
      }
      
      // Ctrl+N to open add modal
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openAddModal();
      }
    });

    // Real-time validation for numeric fields
    function addNumericValidation(inputId, min, max, unit = '') {
      const input = document.getElementById(inputId);
      const errorElement = document.getElementById(inputId.replace(/^(edit|add)-/, '$1-') + '-error');
      
      if (!input || !errorElement) return;
      
      input.addEventListener('blur', function() {
        const value = parseFloat(this.value);
        if (this.value && (isNaN(value) || value < min || value > max)) {
          errorElement.textContent = `Value must be between ${min} and ${max}${unit}`;
          this.style.borderColor = 'var(--error)';
        } else {
          errorElement.textContent = '';
          this.style.borderColor = '';
        }
      });
      
      input.addEventListener('input', function() {
        if (this.style.borderColor === 'var(--error)') {
          this.style.borderColor = '';
          errorElement.textContent = '';
        }
      });
    }

    // Apply validation to all numeric fields
    const numericFields = [
      {id: 'edit-systolic', min: 70, max: 250, unit: ' mmHg'},
      {id: 'edit-diastolic', min: 40, max: 150, unit: ' mmHg'},
      {id: 'edit-pulse', min: 30, max: 200, unit: ' bpm'},
      {id: 'edit-spo2', min: 70, max: 100, unit: '%'},
      {id: 'edit-temperature', min: 95, max: 110, unit: '¬∞F'},
      {id: 'edit-glucose', min: 50, max: 500, unit: ' mg/dL'},
      {id: 'add-systolic', min: 70, max: 250, unit: ' mmHg'},
      {id: 'add-diastolic', min: 40, max: 150, unit: ' mmHg'},
      {id: 'add-pulse', min: 30, max: 200, unit: ' bpm'},
      {id: 'add-spo2', min: 70, max: 100, unit: '%'},
      {id: 'add-temperature', min: 95, max: 110, unit: '¬∞F'},
      {id: 'add-glucose', min: 50, max: 500, unit: ' mg/dL'}
    ];

    numericFields.forEach(field => {
      addNumericValidation(field.id, field.min, field.max, field.unit);
    });
  </script>

  <!-- Edit Report Modal -->
  <div id="edit-report-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Report</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      
      <div class="dropdown-container">
        <label class="form-label" style="display: block; margin-bottom: 8px; color: #FF0080; font-weight: 600;">
          <i class="fas fa-clipboard-list" style="margin-right: 8px;"></i>
          Step 1: Select Report to Edit
        </label>
        <select id="report-select" class="report-dropdown">
          <option value="">Loading reports...</option>
        </select>
        <div style="margin-top: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.6);">
          Choose a report from the list to populate the form fields below
        </div>
      </div>

      <div id="edit-form-container" style="opacity: 0.5; pointer-events: none; transition: all 0.3s ease;">
        <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 0, 128, 0.1); border-radius: 8px; border-left: 4px solid #FF0080;">
          <p style="margin: 0; color: #FF0080; font-size: 14px; font-weight: 600;">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            Step 2: Edit Report Values
          </p>
          <p style="margin: 5px 0 0 0; color: rgba(255, 255, 255, 0.7); font-size: 12px;">
            Form will be enabled after selecting a report above
          </p>
        </div>

      <form id="edit-report-form">
        <div class="form-grid">
          <!-- Blood Pressure -->
          <div class="form-group">
            <label class="form-label">Systolic BP (mmHg)</label>
            <input type="number" id="edit-systolic" class="form-input" placeholder="120" min="70" max="250" step="1">
            <div class="error-message" id="edit-systolic-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Diastolic BP (mmHg)</label>
            <input type="number" id="edit-diastolic" class="form-input" placeholder="80" min="40" max="150" step="1">
            <div class="error-message" id="edit-diastolic-error"></div>
          </div>

          <!-- Heart Rate -->
          <div class="form-group">
            <label class="form-label">Pulse/Heart Rate (bpm)</label>
            <input type="number" id="edit-pulse" class="form-input" placeholder="72" min="30" max="200" step="1">
            <div class="error-message" id="edit-pulse-error"></div>
          </div>

          <!-- SpO2 -->
          <div class="form-group">
            <label class="form-label">SpO2 (%)</label>
            <input type="number" id="edit-spo2" class="form-input" placeholder="98" min="70" max="100" step="1">
            <div class="error-message" id="edit-spo2-error"></div>
          </div>

          <!-- Temperature -->
          <div class="form-group">
            <label class="form-label">Temperature (¬∞F)</label>
            <input type="number" id="edit-temperature" class="form-input" placeholder="98.6" min="95" max="110" step="0.1">
            <div class="error-message" id="edit-temperature-error"></div>
          </div>

          <!-- Blood Glucose -->
          <div class="form-group">
            <label class="form-label">Blood Glucose (mg/dL)</label>
            <input type="number" id="edit-glucose" class="form-input" placeholder="100" min="50" max="500" step="1">
            <div class="error-message" id="edit-glucose-error"></div>
          </div>

          <!-- Irregular Heartbeat -->
          <div class="form-group">
            <label class="form-label">Irregular Heartbeat</label>
            <select id="edit-irregular" class="form-input">
              <option value="">Select...</option>
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
            <div class="error-message" id="edit-irregular-error"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="save-edit-btn" disabled>
            <i class="fas fa-save"></i>
            Save Changes
          </button>
        </div>
      </form>
      </div> <!-- Close edit-form-container -->
    </div>
  </div>

  <!-- Add New Report Modal -->
  <div id="add-report-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add New Report</h3>
        <button class="modal-close" onclick="closeAddModal()">&times;</button>
      </div>

      <form id="add-report-form">
        <div class="form-grid">
          <!-- Blood Pressure -->
          <div class="form-group">
            <label class="form-label">Systolic BP (mmHg)</label>
            <input type="number" id="add-systolic" class="form-input" placeholder="120" min="70" max="250" step="1">
            <div class="error-message" id="add-systolic-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Diastolic BP (mmHg)</label>
            <input type="number" id="add-diastolic" class="form-input" placeholder="80" min="40" max="150" step="1">
            <div class="error-message" id="add-diastolic-error"></div>
          </div>

          <!-- Heart Rate -->
          <div class="form-group">
            <label class="form-label">Pulse/Heart Rate (bpm)</label>
            <input type="number" id="add-pulse" class="form-input" placeholder="72" min="30" max="200" step="1">
            <div class="error-message" id="add-pulse-error"></div>
          </div>

          <!-- SpO2 -->
          <div class="form-group">
            <label class="form-label">SpO2 (%)</label>
            <input type="number" id="add-spo2" class="form-input" placeholder="98" min="70" max="100" step="1">
            <div class="error-message" id="add-spo2-error"></div>
          </div>

          <!-- Temperature -->
          <div class="form-group">
            <label class="form-label">Temperature (¬∞F)</label>
            <input type="number" id="add-temperature" class="form-input" placeholder="98.6" min="95" max="110" step="0.1">
            <div class="error-message" id="add-temperature-error"></div>
          </div>

          <!-- Blood Glucose -->
          <div class="form-group">
            <label class="form-label">Blood Glucose (mg/dL)</label>
            <input type="number" id="add-glucose" class="form-input" placeholder="100" min="50" max="500" step="1">
            <div class="error-message" id="add-glucose-error"></div>
          </div>

          <!-- Irregular Heartbeat -->
          <div class="form-group">
            <label class="form-label">Irregular Heartbeat</label>
            <select id="add-irregular" class="form-input">
              <option value="">Select...</option>
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
            <div class="error-message" id="add-irregular-error"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="save-add-btn">
            <i class="fas fa-plus"></i>
            Add Report
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success/Error Notification -->
  <div id="notification" style="position: fixed; top: 20px; right: 20px; z-index: 1001; padding: 15px 20px; border-radius: 10px; color: white; font-weight: 500; transform: translateX(100%); transition: transform 0.3s ease; max-width: 300px;">
  </div>

</body>

</html>